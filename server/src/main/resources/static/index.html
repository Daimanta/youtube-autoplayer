<!DOCTYPE html>
<html lang="en">
<script>
function playPause() {
    fetch('/api/play');
    setTimeout(getPlaylist, 400);
}

function stop() {
    fetch('/api/stop');
    setTimeout(getPlaylist, 400);
}

function fullscreen() {
    fetch('/api/fullscreen');
}

function volumeup() {
    fetch('/api/volumeup');
}

function volumedown() {
    fetch('api/volumedown');
}

function next() {
    fetch('api/next');
    setTimeout(getPlaylist, 400);
}

function previous() {
    fetch('api/previous');
    setTimeout(getPlaylist, 400);
}

function emptyPlaylist() {
    fetch('api/emptyplaylist');
    setTimeout(getPlaylist, 400);
}

function addToQueue() {
    const queueInputElement = document.getElementById("queue_input_id");
    const video = queueInputElement.value || null;
    if (video == null) return;
    fetch('api/queue?video=' + video);
    queueInputElement.value = "";
}

function playItem(itemId) {
    fetch('api/select/'+itemId);
    setTimeout(getPlaylist, 400);
}

function setVolume() {
    const value = document.getElementById("volume_slider_id").value;
    fetch('api/setvolume?value=' + document.getElementById("volume_slider_id").value);
    document.getElementById("volume_value_id").textContent = value;
}

function updateValue() {
    document.getElementById("volume_value_id").textContent = document.getElementById("volume_slider_id").value;
}

function getPlaylist() {
    fetch('api/getplaylist').then(async (response) => {
        const data = await response.json();
        const table_body = document.getElementById("playlist_table_body_id");
        table_body.innerHTML = "";
        if (data.items.length === 0) {
            const row = document.createElement("tr");
            let i = 0;
            while (i < 3) {
                const col = document.createElement("td");
                col.textContent = "-";
                row.appendChild(col);
                i++;
            }
            table_body.appendChild(row);
        } else {
            for (let entry of data.items) {
                const row = document.createElement("tr");
                const playActiveCol = document.createElement("td");
                if (entry.id === "plid_"+data.activeIndex) {
                    playActiveCol.textContent = "â†’";
                }
                const titleCol = document.createElement("td");
                if (entry.id.startsWith("plid_")) {
                    const titleColLink = document.createElement("a");
                    titleColLink.textContent = entry.title;
                    titleColLink.href = "#";
                    titleColLink.onclick = () => {playItem(entry.id)};
                    titleCol.appendChild(titleColLink);
                } else {
                    titleCol.textContent = entry.title;
                }

                const durationCol = document.createElement("td");
                durationCol.textContent = lengthString(entry.duration);
                row.appendChild(playActiveCol);
                row.appendChild(titleCol);
                row.appendChild(durationCol);
                table_body.appendChild(row);
            }
        }
    });
}

function lengthString(duration) {
    if (duration >= 3600) {
        const hours = Math.floor(duration / 3600);
        const minutes = (""+Math.floor((duration % 3600) / 60)).padStart(2, '0');
        const seconds = (""+(duration % 60)).padStart(2, '0');
        return "" + hours + ":" + minutes + ":" + seconds;
    } else if (duration >= 60) {
        const minutes = (""+(Math.floor(duration / 60))).padStart(2, '0');
        const seconds = (""+(duration % 60)).padStart(2, '0');
        return "" + minutes + ":" + seconds;
    } else {
        return "00:" + (""+duration).padStart(2, '0');
    }
}

function executeOnPageLoad() {
    fetch("api/vlcstatus").then(
        async (response) => {
            const data = await response.json();
            const volume = Math.floor((data.volume / 512.0) * 200.0);
            document.getElementById("volume_slider_id").value = volume;
            document.getElementById("volume_value_id").textContent = volume;
        }
    );
}

window.onload = executeOnPageLoad;
</script>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
    <link rel="stylesheet" href="styles.css">
    <title>Playback remote control</title>
</head>
<h1>Playback remote control</h1>

<button type="button" class="iconbutton" onclick="playPause()"><img src="images/play.svg" height="25"/></button>
<button type="button" class="iconbutton" onclick="stop()"><img src="images/stop.svg" height="25"/></button>
<button type="button" class="iconbutton" onclick="previous()"><img src="images/back.svg" height="25"/></button>
<button type="button" class="iconbutton" onclick="next()"><img src="images/forward.svg" height="25"/></button>
<input type="range" min="1" max="125" value="50" class="slider" id="volume_slider_id" onchange="setVolume()" oninput="updateValue()">
<span id="volume_value_id">0</span>
<br>
<button type="button" class="textbutton" onclick="fullscreen()">Fullscreen</button>
<button type="button" class="textbutton" onclick="emptyPlaylist()">Empty playlist</button>
<br>
<input type="text" id="queue_input_id" style="width:30em">
<button type="button" class="textbutton" onclick="addToQueue()">Add to queue</button>
<br>
<button type="button" class="textbutton" onclick="getPlaylist()">Refresh playlist</button>
<table id="playlist_table_id">
    <thead>
    <tr>
        <th>-</th>
        <th>Name</th>
        <th>Duration</th>
    </tr>
    </thead>
    <tbody id="playlist_table_body_id">
    <tr>
        <th>-</th>
        <th>-</th>
        <th>-</th>
    </tr>
    </tbody>
</table>
</html>